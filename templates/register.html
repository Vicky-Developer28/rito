{% extends "base.html" %}
{% load static %}

{% block title %}Register Device - Rito System{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-slate-900 to-slate-800 py-8">
    <div class="max-w-2xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Back Button -->
        <div class="mb-6">
            <a href="{% url 'user:dashboard' %}" class="inline-flex items-center text-blue-400 hover:text-blue-300 transition-colors">
                <i class="fas fa-arrow-left mr-2"></i>
                Back to Dashboard
            </a>
        </div>

        <!-- Header -->
        <div class="text-center mb-8">
            <div class="w-20 h-20 bg-blue-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-microchip text-blue-400 text-3xl"></i>
            </div>
            <h1 class="text-3xl font-bold text-white mb-2">
                {% if device %}Update Device{% else %}Register New Device{% endif %}
            </h1>
            <p class="text-gray-400">
                {% if device %}
                    Update your device information or register a new device
                {% else %}
                    Connect your hardware device to start using the Rito System
                {% endif %}
            </p>
        </div>

        <!-- Registration Form -->
        <div class="dark-card rounded-xl p-6">
            <form method="post" class="space-y-6" id="registrationForm">
                {% csrf_token %}
                
                <!-- IEDA Input -->
                <div>
                    <label for="ieda" class="block text-gray-400 text-sm font-medium mb-2">
                        IEDA (Indian Electrical Device Auth)
                    </label>
                    <input type="text" 
                           id="ieda" 
                           name="ieda" 
                           value="{{ form.ieda.value|default:'' }}"
                           required
                           class="form-input"
                           placeholder="Enter your 64-character IEDA"
                           pattern="[a-fA-F0-9]{64}"
                           title="64-character hexadecimal IEDA">
                    {% if form.ieda.errors %}
                    <div class="text-red-400 text-sm mt-1">
                        {% for error in form.ieda.errors %}
                            {{ error }}
                        {% endfor %}
                    </div>
                    {% endif %}
                    <p class="text-gray-500 text-xs mt-1">
                        Your IEDA is a 64-character hexadecimal string generated by your device
                    </p>
                </div>

                <!-- Registration Code -->
                <div>
                    <label for="code" class="block text-gray-400 text-sm font-medium mb-2">
                        Registration Code
                    </label>
                    <div class="flex space-x-3">
                        <input type="text" 
                               id="code" 
                               name="code" 
                               value="{{ form.code.value|default:'' }}"
                               required
                               class="form-input flex-1"
                               placeholder="Enter 6-digit code from device"
                               pattern="[0-9]{6}"
                               title="6-digit registration code"
                               maxlength="6">
                        <button type="button" 
                                onclick="refreshRegistrationCode()" 
                                id="refreshBtn"
                                class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors flex items-center whitespace-nowrap">
                            <i class="fas fa-sync-alt mr-2"></i>
                            Refresh Code
                        </button>
                    </div>
                    {% if form.code.errors %}
                    <div class="text-red-400 text-sm mt-1">
                        {% for error in form.code.errors %}
                            {{ error }}
                        {% endfor %}
                    </div>
                    {% endif %}
                    <p class="text-gray-500 text-xs mt-1">
                        6-digit code displayed on your device. Click refresh to request a new code.
                    </p>
                </div>

                <!-- Device Status -->
                <div id="deviceStatus" class="hidden">
                    <div class="p-4 bg-blue-500/10 border border-blue-500/30 rounded-lg">
                        <div class="flex items-center">
                            <i class="fas fa-info-circle text-blue-400 mr-3"></i>
                            <div>
                                <h4 class="text-blue-300 font-semibold">Device Status</h4>
                                <p class="text-blue-200/80 text-sm" id="statusMessage">
                                    Checking device status...
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Device Type -->
                <div>
                    <label class="block text-gray-400 text-sm font-medium mb-2">
                        Device Type
                    </label>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="flex items-center p-4 bg-slate-800/50 rounded-lg border border-slate-700">
                            <input type="radio" id="type_esp8266" name="device_type" value="esp8266" class="mr-3" checked>
                            <label for="type_esp8266" class="text-white cursor-pointer">
                                <i class="fas fa-microchip text-blue-400 mr-2"></i>
                                ESP8266
                            </label>
                        </div>
                        <div class="flex items-center p-4 bg-slate-800/50 rounded-lg border border-slate-700">
                            <input type="radio" id="type_custom" name="device_type" value="custom" class="mr-3">
                            <label for="type_custom" class="text-white cursor-pointer">
                                <i class="fas fa-laptop text-green-400 mr-2"></i>
                                Custom Device
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Terms Agreement -->
                <div class="flex items-start space-x-3 p-4 bg-slate-800/30 rounded-lg">
                    <input type="checkbox" 
                           id="terms" 
                           name="terms" 
                           required
                           class="mt-1 rounded border-gray-600 bg-slate-700 text-blue-500 focus:ring-blue-500 focus:ring-offset-slate-800">
                    <label for="terms" class="text-gray-300 text-sm">
                        I agree to the <a href="#" class="text-blue-400 hover:text-blue-300">Terms of Service</a> 
                        and <a href="#" class="text-blue-400 hover:text-blue-300">Privacy Policy</a>. 
                        I confirm that this device meets the security requirements for the Rito System.
                    </label>
                </div>

                <!-- Submit Button -->
                <div class="flex space-x-4">
                    <button type="submit" class="btn-primary flex-1" id="submitBtn">
                        <i class="fas fa-microchip mr-2"></i>
                        {% if device %}Update Device{% else %}Register Device{% endif %}
                    </button>
                    <a href="{% url 'user:dashboard' %}" class="px-6 py-3 border border-gray-600 text-gray-300 hover:bg-slate-800 rounded-lg transition-colors flex items-center justify-center">
                        Cancel
                    </a>
                </div>
            </form>
        </div>

        <!-- Help Section -->
        <div class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Getting IEDA -->
            <div class="dark-card rounded-xl p-6">
                <div class="flex items-center mb-4">
                    <div class="w-10 h-10 bg-green-500/20 rounded-full flex items-center justify-center mr-3">
                        <i class="fas fa-qrcode text-green-400"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-white">Getting Your IEDA</h3>
                </div>
                <ul class="text-gray-400 space-y-2 text-sm">
                    <li class="flex items-start">
                        <i class="fas fa-check text-green-400 mr-2 mt-1"></i>
                        Power on your Rito-compatible device
                    </li>
                    <li class="flex items-start">
                        <i class="fas fa-check text-green-400 mr-2 mt-1"></i>
                        Navigate to Device Information in the menu
                    </li>
                    <li class="flex items-start">
                        <i class="fas fa-check text-green-400 mr-2 mt-1"></i>
                        Copy the 64-character IEDA string
                    </li>
                    <li class="flex items-start">
                        <i class="fas fa-check text-green-400 mr-2 mt-1"></i>
                        Enter it in the form above
                    </li>
                </ul>
            </div>

            <!-- Registration Code -->
            <div class="dark-card rounded-xl p-6">
                <div class="flex items-center mb-4">
                    <div class="w-10 h-10 bg-blue-500/20 rounded-full flex items-center justify-center mr-3">
                        <i class="fas fa-mobile-alt text-blue-400"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-white">Registration Code</h3>
                </div>
                <ul class="text-gray-400 space-y-2 text-sm">
                    <li class="flex items-start">
                        <i class="fas fa-check text-green-400 mr-2 mt-1"></i>
                        Check your device display for the 6-digit code
                    </li>
                    <li class="flex items-start">
                        <i class="fas fa-check text-green-400 mr-2 mt-1"></i>
                        Code refreshes every 60 seconds for security
                    </li>
                    <li class="flex items-start">
                        <i class="fas fa-check text-green-400 mr-2 mt-1"></i>
                        Enter the current code displayed on your device
                    </li>
                    <li class="flex items-start">
                        <i class="fas fa-check text-green-400 mr-2 mt-1"></i>
                        Contact support if the code doesn't appear
                    </li>
                </ul>
            </div>
        </div>

        <!-- Security Notice -->
        <div class="mt-6 p-4 bg-yellow-500/10 border border-yellow-500/30 rounded-lg">
            <div class="flex items-start">
                <i class="fas fa-exclamation-triangle text-yellow-400 mt-1 mr-3"></i>
                <div>
                    <h4 class="text-yellow-300 font-semibold mb-1">Security Notice</h4>
                    <p class="text-yellow-200/80 text-sm">
                        Only register devices from trusted sources. Your IEDA and registration code 
                        are sensitive information - never share them with anyone. 
                        <a href="#" class="underline">Learn more about device security</a>.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
    // Auto-format IEDA input
    document.getElementById('ieda').addEventListener('input', function(e) {
        let value = e.target.value.replace(/[^a-fA-F0-9]/g, '').toUpperCase();
        e.target.value = value;
    });

    // Auto-format registration code
    document.getElementById('code').addEventListener('input', function(e) {
        let value = e.target.value.replace(/[^0-9]/g, '');
        if (value.length > 6) {
            value = value.substring(0, 6);
        }
        e.target.value = value;
    });

    // Refresh registration code
    async function refreshRegistrationCode() {
        const ieda = document.getElementById('ieda').value;
        const refreshBtn = document.getElementById('refreshBtn');
        const originalText = refreshBtn.innerHTML;
        
        if (!ieda) {
            showNotification('Please enter IEDA first', 'error');
            return;
        }

        refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Requesting...';
        refreshBtn.disabled = true;

        try {
            const response = await fetch('/api/device/refresh-code/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    ieda: ieda
                })
            });
            
            const data = await response.json();
            
            if (data.status === 'success') {
                showNotification('New registration code requested from device', 'success');
                // Update the code input field
                document.getElementById('code').value = data.registration_code;
            } else {
                showNotification('Failed to refresh code: ' + data.message, 'error');
            }
        } catch (error) {
            showNotification('Error refreshing code: ' + error, 'error');
        } finally {
            refreshBtn.innerHTML = originalText;
            refreshBtn.disabled = false;
        }
    }

    // Check device status when IEDA is entered
    document.getElementById('ieda').addEventListener('blur', function() {
        const ieda = this.value;
        if (ieda && ieda.length === 64) {
            checkDeviceStatus(ieda);
        }
    });

    // Check device status
    async function checkDeviceStatus(ieda) {
        const statusDiv = document.getElementById('deviceStatus');
        const statusMessage = document.getElementById('statusMessage');
        
        statusDiv.classList.remove('hidden');
        statusMessage.textContent = 'Checking device status...';

        try {
            const response = await fetch('/api/device/status/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    ieda: ieda
                })
            });
            
            const data = await response.json();
            
            if (data.status === 'success') {
                if (data.registered) {
                    statusMessage.innerHTML = `
                        <span class="text-green-400">✓ Device is already registered</span><br>
                        <small class="text-blue-300">Rito ID: ${data.rito_id}</small>
                    `;
                    statusDiv.className = statusDiv.className.replace('bg-blue-500/10', 'bg-green-500/10');
                    statusDiv.className = statusDiv.className.replace('border-blue-500/30', 'border-green-500/30');
                } else {
                    statusMessage.innerHTML = `
                        <span class="text-yellow-400">⚠ Device found but not registered</span><br>
                        <small class="text-gray-300">Current code: ${data.registration_code}</small>
                    `;
                    statusDiv.className = statusDiv.className.replace('bg-blue-500/10', 'bg-yellow-500/10');
                    statusDiv.className = statusDiv.className.replace('border-blue-500/30', 'border-yellow-500/30');
                    
                    // Auto-fill the code if available
                    if (data.registration_code) {
                        document.getElementById('code').value = data.registration_code;
                    }
                }
            } else {
                statusMessage.innerHTML = `
                    <span class="text-red-400">✗ Device not found in system</span><br>
                    <small class="text-gray-300">Please ensure device is connected and has requested a code</small>
                `;
                statusDiv.className = statusDiv.className.replace('bg-blue-500/10', 'bg-red-500/10');
                statusDiv.className = statusDiv.className.replace('border-blue-500/30', 'border-red-500/30');
            }
        } catch (error) {
            statusMessage.textContent = 'Error checking device status';
            statusDiv.className = statusDiv.className.replace('bg-blue-500/10', 'bg-red-500/10');
            statusDiv.className = statusDiv.className.replace('border-blue-500/30', 'border-red-500/30');
        }
    }

    // Form validation
    document.getElementById('registrationForm').addEventListener('submit', function(e) {
        const ieda = document.getElementById('ieda').value;
        const code = document.getElementById('code').value;
        const terms = document.getElementById('terms').checked;

        if (!ieda || ieda.length !== 64) {
            e.preventDefault();
            showNotification('Please enter a valid 64-character IEDA', 'error');
            return;
        }

        if (!code || code.length !== 6) {
            e.preventDefault();
            showNotification('Please enter a valid 6-digit registration code', 'error');
            return;
        }

        if (!terms) {
            e.preventDefault();
            showNotification('Please agree to the terms and conditions', 'error');
            return;
        }

        // Show loading state
        const submitBtn = document.getElementById('submitBtn');
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Registering...';
        submitBtn.disabled = true;
    });

    // Notification system
    function showNotification(message, type) {
        // Remove existing notifications
        const existingNotifications = document.querySelectorAll('.custom-notification');
        existingNotifications.forEach(notification => notification.remove());

        // Create notification element
        const notification = document.createElement('div');
        notification.className = `custom-notification fixed top-4 right-4 p-4 rounded-lg z-50 transform transition-all duration-300 ${
            type === 'success' ? 'bg-green-600' : 'bg-red-600'
        } text-white shadow-lg`;
        notification.innerHTML = `
            <div class="flex items-center">
                <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'} mr-2"></i>
                <span>${message}</span>
            </div>
        `;
        
        document.body.appendChild(notification);
        
        // Animate in
        setTimeout(() => {
            notification.classList.add('translate-x-0', 'opacity-100');
        }, 10);

        // Remove after 5 seconds
        setTimeout(() => {
            notification.classList.remove('translate-x-0', 'opacity-100');
            notification.classList.add('translate-x-full', 'opacity-0');
            setTimeout(() => {
                notification.remove();
            }, 300);
        }, 5000);
    }

    // Initialize notification styles
    const style = document.createElement('style');
    style.textContent = `
        .custom-notification {
            transform: translateX(100%);
            opacity: 0;
        }
        .custom-notification.translate-x-0 {
            transform: translateX(0);
            opacity: 1;
        }
    `;
    document.head.appendChild(style);
</script>
{% endblock %}
{% endblock %}